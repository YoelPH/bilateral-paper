{
  "hash": "3f0b25666f8ae577359c8d9d5da1b572",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"Probabilistic Model of Bilateral Lymphatic Spread in Head and Neck Cancer\"\n---\n\n::: {#c8ed7e63 .cell execution_count=2}\n``` {.python .cell-code .hidden}\nimport re\n\nimport pandas as pd\nimport numpy as np\nimport matplotlib.pyplot as plt\nfrom matplotlib import ticker\nfrom matplotlib.colors import LinearSegmentedColormap\nimport upsetplot\n\nfrom lymph import models\nfrom lyscripts import utils\nfrom lyscripts.plot.utils import COLORS\n\nfrom scripts import shared, paths, COL, get_lnl_cols\n\nmidline_model = shared.get_model(\"midline\", load_samples=True)\n```\n:::\n\n\n::: {#44106081 .cell tags='[\"parameters\"]' execution_count=3}\n``` {.python .cell-code .hidden}\n# width of figures. May depend on number of text columns\nfull = 17 # cm\nhalf = full\n# half =  8 # cm\n```\n:::\n\n\n:::{#a6ef360c .cell .markdown}\n# Introduction\n\n- head and neck cancer spreads through the lymphatic network\n- may sometimes spread to contralateral side\n- spreads more frequently and to larger extent contralaterally when tumor extends the mid-sagittal line\n- we describe a model based on previously published hidden Markov model\n- we extend it to cover the contralateral side, too\n- naive approach: make two independent models for each side, but that is not supported by the data\n- ipsi- and contralateral side are correlated via time of diagnosis, which is correlated with T-category\n- tumor extension over mid-sagittal line is modelled as random variable\n- spread probabilities from tumor to contralateral LNLs in case of midline extesnion are linear combinations of these probabilities in case of ipsilateral spread and contralateral spread when tumor is clearly lateralized\n\n\n# Data on Lymphatic Progression Patterns\n\nWe have collected a detailed dataset of <!-- num patients --> patients with newly diagnosed oropharyngeal squamous cell carcinomas. It reports the involvement of every patient individually and per lymph node level in tabular form, in addition to other clinico-pathological information such as age, T-category, and HPV p16 status.\n\nTheir patient records have been collected at four different institutions and a brief overview over some of their patients' characteristics are shown in @tbl-data-overview. Note that the data from the Inselspital Bern and the Centre Léon Bérard only consists of patients treated with some form of neck dissection. Since this treatment is more commonly chosen for early T-category patients, they also make up a larger portion of the respective dataset.\n:::\n\n::: {#tbl-data-overview .cell tbl-cap='Overview over the five datasets from four different institutions used to train and evaluate our model. Here, we briefly characterize the total number of OPSCC patients from the respective institution, their median age, what proportion received some form of neck dissection, the N0 portion of patients, what percentage presented with early T-category, and the prevalence of primary tumor midline extension. For a much more detailed look at the data, visit [lyprox.org](https://lyprox.org).' execution_count=4}\n``` {.python .cell-code .hidden}\nfrom typing import Literal\n\ndef align(\n  column: pd.Series,\n  where: Literal[\"right\", \"left\", \"center\"],\n) -> list[str]:\n  \"\"\"Align a column.\"\"\"\n  return [f\"text-align: {where}\"] * len(column)\n\ndef right_align(column: pd.Series) -> list[str]:\n  \"\"\"Right align column.\"\"\"\n  return align(column, where=\"right\")\n\ndef highlight_bool(\n  column: pd.Series,\n  c_false: str = COLORS[\"green\"],\n  c_true: str = COLORS[\"red\"],\n) -> list[str]:\n  \"\"\"Make cell read (`False`) or green (`True`).\"\"\"\n  n = len(column)\n  trues = pd.Series([c_true] * n)\n  falses = pd.Series([c_false] * n)\n  colors = trues.where(column, falses)\n  return colors.map(lambda x: f\"color: {x}\")\n\ndef highlight_t_stage(\n  column: pd.Series,\n  c_early: str = COLORS[\"green\"],\n  c_late: str = COLORS[\"red\"],\n) -> list[str]:\n  \"\"\"Highlight `early` and `late`.\"\"\"\n  is_early = column == \"early\"\n  return highlight_bool(is_early, c_false=c_late, c_true=c_early)\n\n\ncol_map = {\n  COL.inst: \"Institution\",\n  COL.age: \"Age\",\n  COL.nd: \"Neck Dissection\",\n  COL.t_stage: \"T-category\",\n  COL.n_stage: \"N-category\",\n}\nshort_col_map = {tpl[-1]: val for tpl, val in col_map.items()}\n\nraw = utils.load_patient_data(paths.data)\nsubdata = raw[col_map.keys()]\nsubdata.columns = subdata.columns.get_level_values(2)\nsubdata = (\n  subdata\n  .rename(columns=short_col_map)\n  .reset_index(drop=True)\n)\n\ndef n0_mean(n_stage: pd.Series) -> float:\n  \"\"\"Compute portion of N0 patients.\"\"\"\n  return (n_stage == 0).mean()\n\ndef early_mean(t_stage: pd.Series) -> float:\n  \"\"\"Compute early T-category portion.\"\"\"\n  return t_stage.isin([0,1,2]).mean()\n\ngrouped = (\n  raw.groupby(\n    by=COL.inst,\n  ).aggregate(**{\n    \"Total\": pd.NamedAgg(column=COL.age, aggfunc=\"count\"),\n    \"Age (median)\": pd.NamedAgg(column=COL.age, aggfunc=\"median\"),\n    \"Neck Dissection\": pd.NamedAgg(column=COL.nd, aggfunc=\"mean\"),\n    \"N0\": pd.NamedAgg(column=COL.n_stage, aggfunc=n0_mean),\n    \"Early T-Cat.\": pd.NamedAgg(column=COL.t_stage, aggfunc=early_mean),\n    \"Mid. Ext.\": pd.NamedAgg(column=COL.midext, aggfunc=\"mean\"),\n  }).convert_dtypes()\n)\ngrouped.index.name = \"Institution\"\n(\n  grouped\n  .reset_index()\n  .style\n  .format(\n    formatter=\"{:>.0%}\",\n    subset=[\"Neck Dissection\", \"N0\", \"Early T-Cat.\", \"Mid. Ext.\"],\n  )\n  .apply(\n    func=right_align,\n    axis=\"index\",\n    subset=grouped.columns[0:],\n  )\n  .hide()\n)\n```\n\n::: {.cell-output .cell-output-display execution_count=13}\n```{=html}\n<style type=\"text/css\">\n#T_6efd1_row0_col1, #T_6efd1_row0_col2, #T_6efd1_row0_col3, #T_6efd1_row0_col4, #T_6efd1_row0_col5, #T_6efd1_row0_col6, #T_6efd1_row1_col1, #T_6efd1_row1_col2, #T_6efd1_row1_col3, #T_6efd1_row1_col4, #T_6efd1_row1_col5, #T_6efd1_row1_col6, #T_6efd1_row2_col1, #T_6efd1_row2_col2, #T_6efd1_row2_col3, #T_6efd1_row2_col4, #T_6efd1_row2_col5, #T_6efd1_row2_col6, #T_6efd1_row3_col1, #T_6efd1_row3_col2, #T_6efd1_row3_col3, #T_6efd1_row3_col4, #T_6efd1_row3_col5, #T_6efd1_row3_col6 {\n  text-align: right;\n}\n</style>\n<table id=\"T_6efd1\">\n  <thead>\n    <tr>\n      <th id=\"T_6efd1_level0_col0\" class=\"col_heading level0 col0\" >Institution</th>\n      <th id=\"T_6efd1_level0_col1\" class=\"col_heading level0 col1\" >Total</th>\n      <th id=\"T_6efd1_level0_col2\" class=\"col_heading level0 col2\" >Age (median)</th>\n      <th id=\"T_6efd1_level0_col3\" class=\"col_heading level0 col3\" >Neck Dissection</th>\n      <th id=\"T_6efd1_level0_col4\" class=\"col_heading level0 col4\" >N0</th>\n      <th id=\"T_6efd1_level0_col5\" class=\"col_heading level0 col5\" >Early T-Cat.</th>\n      <th id=\"T_6efd1_level0_col6\" class=\"col_heading level0 col6\" >Mid. Ext.</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td id=\"T_6efd1_row0_col0\" class=\"data row0 col0\" >Centre Léon Bérard</td>\n      <td id=\"T_6efd1_row0_col1\" class=\"data row0 col1\" >325</td>\n      <td id=\"T_6efd1_row0_col2\" class=\"data row0 col2\" >60</td>\n      <td id=\"T_6efd1_row0_col3\" class=\"data row0 col3\" >100%</td>\n      <td id=\"T_6efd1_row0_col4\" class=\"data row0 col4\" >19%</td>\n      <td id=\"T_6efd1_row0_col5\" class=\"data row0 col5\" >69%</td>\n      <td id=\"T_6efd1_row0_col6\" class=\"data row0 col6\" >18%</td>\n    </tr>\n    <tr>\n      <td id=\"T_6efd1_row1_col0\" class=\"data row1 col0\" >Inselspital Bern</td>\n      <td id=\"T_6efd1_row1_col1\" class=\"data row1 col1\" >74</td>\n      <td id=\"T_6efd1_row1_col2\" class=\"data row1 col2\" >61</td>\n      <td id=\"T_6efd1_row1_col3\" class=\"data row1 col3\" >100%</td>\n      <td id=\"T_6efd1_row1_col4\" class=\"data row1 col4\" >18%</td>\n      <td id=\"T_6efd1_row1_col5\" class=\"data row1 col5\" >66%</td>\n      <td id=\"T_6efd1_row1_col6\" class=\"data row1 col6\" >14%</td>\n    </tr>\n    <tr>\n      <td id=\"T_6efd1_row2_col0\" class=\"data row2 col0\" >University Hospital Zurich</td>\n      <td id=\"T_6efd1_row2_col1\" class=\"data row2 col1\" >287</td>\n      <td id=\"T_6efd1_row2_col2\" class=\"data row2 col2\" >66</td>\n      <td id=\"T_6efd1_row2_col3\" class=\"data row2 col3\" >26%</td>\n      <td id=\"T_6efd1_row2_col4\" class=\"data row2 col4\" >18%</td>\n      <td id=\"T_6efd1_row2_col5\" class=\"data row2 col5\" >52%</td>\n      <td id=\"T_6efd1_row2_col6\" class=\"data row2 col6\" >31%</td>\n    </tr>\n    <tr>\n      <td id=\"T_6efd1_row3_col0\" class=\"data row3 col0\" >Vall d'Hebron Barcelona Hospital</td>\n      <td id=\"T_6efd1_row3_col1\" class=\"data row3 col1\" >147</td>\n      <td id=\"T_6efd1_row3_col2\" class=\"data row3 col2\" >58</td>\n      <td id=\"T_6efd1_row3_col3\" class=\"data row3 col3\" >5%</td>\n      <td id=\"T_6efd1_row3_col4\" class=\"data row3 col4\" >21%</td>\n      <td id=\"T_6efd1_row3_col5\" class=\"data row3 col5\" >34%</td>\n      <td id=\"T_6efd1_row3_col6\" class=\"data row3 col6\" >34%</td>\n    </tr>\n  </tbody>\n</table>\n```\n:::\n:::\n\n\n:::{#854ecdb0 .cell .markdown}\n## Contralateral Involvement Prevalence {#sec-data-strat}\n\nThese datasets allow us to investigate correlations between the involvement of individual LNLs, or between risk factors and patterns of involvement. In @fig-data-strat, we have plotted the prevalence of each contralateral LNL's involvement, stratified by T-category, ipsilateral number of involved LNLs, and whether the tumor extended over the mid-sagittal line. A similar but more complete stratification is also tabulated in the appendix in @tbl-data-strat.\n\n\n\n\n\n\n{{< embed data.qmd#fig-data-strat >}}\n\n\n\n\n\n\n\n\n\n\nThe left panel in @fig-data-strat indicates that T-category is correlated with contralateral involvement (as it is with overal involvement). This is simply because T-category may on average be considered a surrogate for the time between onset of disease and diagnosis. I.e., a patient with a T4 tumor was -- on average -- diagnosed later than a patient with a T1 tumor. Thus, the former did have more time to develop metastases.\n\nSimilarly, ipsilateral involvement correlates with contralateral metastasis. The tumor of a patients with many metastases in ipsilateral LNLs was probably able to spread for longer (or faster) compared to a tumor in a patient with no nodal disease. This, too, may therefore be considered a surrogate for the duration of the disease. In rare cases, bulky nodal disease ipsilaterally may also redirect lymph fluids to the contralateral side. <!-- citation needed? -->\n\nLastly, the right panel in @fig-data-strat shows that patients with a tumor crossing the mid-sagittal line show contralateral involvement vastly more often compared to patients with clearly lateralized tumors. This makes intutitive sense, because the lymphatic system in the head and neck region is typically symmetric and thus no major vessels cross the midline. Therefore, interstitial fluids from the primary tumor -- which we assume to carry living malignant cells -- may only reach the blind-ended lymphatic vessels in the contralateral neck via short-ranged diffusion. Which in turn is only possible when the primary tumor is close enough to the mid-sagittal line or crosses it. <!-- citation(s) needed? or is this intuition good enough? -->\n\n\n## Requirements for a Bilateral Model\n\nBased on the observations of the [previous section](#sec-data-strat), any potential model that aims to also predict the risk for contralateral nodal involvement, should be able to take the following into account:\n\n1. More advanced T-category should lead to higher risk for nodal disease. One approach to achieve this via the expected time of diagnosis has already been developed in the form of a hidden Markov model [@ludwig_hidden_2021].\n2. The degree of ipsilateral involvement should give the model information on the time that may have passed between onset and diagnosis of the disease. This should come in addition to what can be inferred about this time from T-category alone.\n3. A tumor that extends over the mid-sagittal line should yield contralateral metastases with much higher probability.\n\nOver the course of this work, we will first briefly recap the mentioned HMM in @sec-unilateral, which was so far used to model ipsilateral lymphatic progression only. Then, we intuitively extend it to include the contralateral side as well in @sec-ext-to-contra. In this section, we also introduce a way of modelling the tumor's midline extension as a random variable (@sec-midline) and lastly talk about how it may affect the contralateral spread in @sec-params-symmetry.\n\n<!-- TODO: Hint at methods and results... -->\n\n\n## Data Availability\n\nThe entire data, including additional patients with tumors in other primary locations than the oropharynx, is publicly available: It may be [downloaded from LyProX](https://lyprox.org/patients/dataset) where it can be interactively explored too, [from GitHub](https://github.com/rmnldwg/lydata), [from zenodo](https://zenodo.org/search?q=lydata), or via the *Data-in-Brief* publications @ludwig_dataset_2022 and @ludwig_multicentric_2023. Although these publications do not include the most recent dataset addition from Vall d'Hebron Barcelona Hospital.\n\n\n# Unilateral Model for Lymphatic Progression {#sec-unilateral}\n\n![Directed acyclic graph (DAG) representing the abstract lymphatic network in the head and neck region. Blue nodes are the LNLs' hidden random variables, the red node represents the tumor, and the orange square nodes depict the binary observed variables. Red and blue arcs symbolize the probability of lymphatic spread along that edge during one time-step. The orange arcs represent the sensitivity and specificity of the observational modality (e.g. CT, MRI, pathology, ...).](static/small-graph.png){#fig-small-graph width=60%}\n\nOur first model to predict the lymphatic progression of HNSCC was introduced using Bayesian networks [@pouymayou_bayesian_2019]. We subsequently extended this work to a hidden Markov model (HMM) [@ludwig_hidden_2020]. We will briefly summarize this HMM's formalism before building on it to include the contralateral spread in @sec-ext-to-contra.\n\nWe model a patient's state of involvement at an abstract time-step $t$ as a vector of hidden binary random variables:\n\n$$\n\\mathbf{X}[t] = \\begin{pmatrix} X_v[t] \\end{pmatrix} \\qquad v \\in \\left\\{ 1, 2, \\ldots, V \\right\\}\n$$\n\nHere, $V$ is the number of LNLs the model considers. The values a LNL's hidden binary RV may take on are $X_v[t] = 0$ (`False`), meaning the LNL $v$ is healthy or free of metastatic disease, or $X_v[t] = 1$ (`True`), corresponding to some for of tumor presence (i.e., occult or clinical).\n\nSince the state vector $\\mathbf{X}[t]$ is $V$-dimensional and binary, there are $2^V$ distinct possible lymphatic involvement patterns, which we enumerate from $\\boldsymbol{\\xi}_0 = \\begin{pmatrix} 0 & 0 & \\cdots & 0 \\end{pmatrix}$ to $\\boldsymbol{\\xi}_{2^V} = \\begin{pmatrix} 1 & 1 & \\cdots & 1 \\end{pmatrix}$.\n\nAny hidden Markov model is fully described by three quantities:\n\n1. A starting state $\\mathbf{X}[t=0]$ at time $t=0$ just before the patient's tumor formed. In our case, this is always the state where all LNLs are still healthy $\\boldsymbol{\\xi}_0$.\n2. The *transition matrix*\n   $$\n   \\mathbf{A} = \\left( A_{ij} \\right) = \\big( P \\left( \\mathbf{X}[t+1] = \\boldsymbol{\\xi}_j \\mid \\mathbf{X}[t] = \\boldsymbol{\\xi}_i \\right) \\big)\n   $$\n   where the value at row $i$ and column $j$ represents the probability to transition from state $\\boldsymbol{\\xi}_i$ to $\\boldsymbol{\\xi}_j$ during the time-step from $t$ to $t+1$. Note that we prohibit self-healing, meaning that during a transition, no LNL may change their state from $X_v[t]=1$ to $X_v[t+1]=0$. This effectively masks large parts of the transition matrix to be zero.\n3. Lastly, the *observation matrix*\n   $$\n   \\mathbf{B} = \\left( B_{ij} \\right) = \\big( P \\left( \\mathbf{Z} = \\boldsymbol{\\zeta}_j \\mid \\mathbf{X}[t_D] = \\boldsymbol{\\xi}_i \\right) \\big)\n   $$\n   where in row $i$ and at column $j$ we find the probability to *observe* a lymphatic involvement pattern $\\mathbf{Z} = \\boldsymbol{\\zeta}_j$, given that the true (but hidden) state of involvement at the time of diagnosis $t_D$ is $\\mathbf{X}[t_D] = \\boldsymbol{\\xi}_i$.\n\nThe transition matrix $\\mathbf{A}$ is parametrized using the spread probabilities of a directed acyclic graph (DAG) that we define as the underlying mechanistic representation of the lymphatic network. An example of such a DAG is shown in @fig-small-graph.\n\nUsing the introduced quantities, we can evolve the distribution of all possible hidden states from $\\mathbf{X}[t=0] = \\boldsymbol{\\xi}_0$ step by step, by successively multiplying this vector with the transition matrix $\\mathbf{A}$. At the time of the diagnosis, we multiply the result with the observation matrix $\\mathbf{B}$. We may then look up the likelihood of a patient presenting with the diagnosis $\\mathbf{Z}=\\boldsymbol{\\zeta}_i$ in the $i$-th entry of the final result.\n\nHowever, the remaining issue is that we do not know how many time-steps to apply. Although a time-step should be considered an abstract quantity that is relative to the tumor's time-frame, we have no way of measuring it directly. Hence, we rely on a surrogate: T-category depends mostly on the size of the tumor [@brierley_tnm_2017] and may therefore represent for how long it has been growing and also spreading lymphatically.\n\nWe still want to allow for cases where early T-category tumors have already spread extesively to the lymph nodes or where advanced T-category patients present with an N0 neck. These cases may be relatively rare, but not implausible. Hence, we marginalize over the time of diagnosis and choose different distributions for different (groups of) T-categories.\n\n<!-- TODO: Explain here what role our model plays in a Bayesian context. -->\n\n$$\nP \\left( \\mathbf{X} \\mid \\mathbf{Z} \\right) = \\frac{P \\left( \\mathbf{Z} \\mid \\mathbf{X} \\right) P \\left( \\mathbf{X} \\right)}{P \\left( \\mathbf{Z} \\right)}\n$$ {#eq-uni-bayes-law}\n\nLet us for later use define the matrices $\\boldsymbol{\\Lambda}$:\n\n$$\n\\boldsymbol{\\Lambda} = P \\left( \\mathbf{X} \\mid \\mathbf{t} \\right) = \\begin{pmatrix}\n\\boldsymbol{\\pi}^\\intercal \\cdot \\mathbf{A}^0 \\\\\n\\boldsymbol{\\pi}^\\intercal \\cdot \\mathbf{A}^1 \\\\\n\\vdots \\\\\n\\boldsymbol{\\pi}^\\intercal \\cdot \\mathbf{A}^{t_\\text{max}} \\\\\n\\end{pmatrix}\n$$ {#eq-lambda-matrix}\n\nThe $n$-th row in this matrix corresponds to the distribution over hidden states after $t=n-1$ time-steps.\n\n\n# Extension to a Bilateral Model {#sec-ext-to-contra}\n\nA naive approach to model the contralateral lymphatic spread would be to simply employ two independent unilateral models as introduced in @sec-unilateral. During training, one could even enforce some shared parameters between these two models, like the parameterization of the distributions over diagnose times or the spread among the LNLs. Additionally, we could think of an approach to incorporate the primary tumor's mid-sagittal extension as a risk factor.\n\nHowever, this approach lacks a way to describe the correlation between ipsi- and contralateral involvement. This is displayed in @tbl-data-strat and shows how often the contralateral LNLs I, II, III, and IV were involved, given all possible combinations of midline extension, T-category, and ipsilateral LNL III involvement. Unsurprisingly, the prevalence for contralateral involvement is consistently higher when the tumor extends over the mid-sagittal line or is of later T-category. But it is also more frequent when the ipsilateral side shows more severe involvement, which is here shown via the surrogate LNL III.\n\n\nThus, we attempt to extend the formalism in @sec-unilateral in such a way that the model's ipsi- and contralateral side evolve synchronously. To achieve that, we start by writing down the posterior distribution of involvement an analogy to @eq-uni-bayes-law, which is now a joint probability of an involvement $\\mathbf{X}^\\text{i}$ ipsilaterally *and* an involvement $\\mathbf{X}^\\text{c}$ contralaterally, given a diagnosis of the ipsilateral LNLs $\\mathbf{Z}^\\text{i}$ and of the contralateral ones $\\mathbf{Z}^\\text{c}$:\n\n$$\nP \\left( \\mathbf{X}^\\text{i}, \\mathbf{X}^\\text{c} \\mid \\mathbf{Z}^\\text{i}, \\mathbf{Z}^\\text{c} \\right) = \\frac{P \\left( \\mathbf{Z}^\\text{i}, \\mathbf{Z}^\\text{c} \\mid \\mathbf{X}^\\text{i}, \\mathbf{X}^\\text{c} \\right) P \\left( \\mathbf{X}^\\text{i}, \\mathbf{X}^\\text{c} \\right)}{P \\left( \\mathbf{Z}^\\text{i}, \\mathbf{Z}^\\text{c} \\right)}\n$$\n\nThe likelihood of the diagnoses given a hidden state simply factorise: $P \\left( \\mathbf{Z}^\\text{i}, \\mathbf{Z}^\\text{c} \\mid \\mathbf{X}^\\text{i}, \\mathbf{X}^\\text{c} \\right) = P \\left( \\mathbf{Z}^\\text{i} \\mid \\mathbf{X}^\\text{i} \\right) \\cdot P \\left( \\mathbf{Z}^\\text{c} \\mid \\mathbf{X}^\\text{c} \\right)$. And the two factors are contained in the observation matrices $\\mathbf{B}^\\text{i}$ and $\\mathbf{B}^\\text{c}$.\n\nThe term representing the model's prior probability of hidden involvement does not factorize. However, if we assume that lymphatic spread typically does not cross the mid-sagittal line, we can write it as a factorising sum:\n\n$$\n\\begin{aligned}\nP \\left( \\mathbf{X}^\\text{i}, \\mathbf{X}^\\text{c} \\right) &= \\sum_{t=0}^{t_\\text{max}} P(t) \\cdot P \\left( \\mathbf{X}^\\text{i}, \\mathbf{X}^\\text{c} \\mid t \\right) \\\\\n&= \\sum_{t=0}^{t_\\text{max}} P(t) \\cdot P \\left( \\mathbf{X}^\\text{i} \\mid t \\right) \\cdot P \\left( \\mathbf{X}^\\text{c} \\mid t \\right)\n\\end{aligned}\n$$ {#eq-bilateral-marginal}\n\nThis assumption makes intuitive sense: The two sides of the lymphatic network in a typical patient are approximately mirror images of each other. Thus, no major vessels cross the mid-sagittal line. There may, however, be diffusion of lymph fluid accross this line or bulky involvement that redirects lymphatic drainage significantly.\n\nUsing this assumption along with @eq-lambda-matrix, we can write the above distribution algebraically as a product:\n\n$$\nP \\left( \\mathbf{X}^\\text{i} = \\boldsymbol{\\xi}_n, \\mathbf{X}^\\text{c} = \\boldsymbol{\\xi}_m \\right) = \\left[ \\boldsymbol{\\Lambda}^\\intercal_\\text{i} \\cdot \\operatorname{diag} P(\\mathbf{t}) \\cdot \\boldsymbol{\\Lambda}_\\text{c} \\right]_{n,m}\n$$ {#eq-bilateral-marginal-algebra}\n\n\n## Modelling Midline Extension {#sec-midline}\n\nTo account for the increased prevalence of involvement on the contralateral side when the tumor is not clearly lateralized anymore, we also model the tumor's extension over the mid-sagittal line as a binary random variable. It starts lateralized and at every time-step there is a finite probability $p_\\epsilon$ that the tumor grows over the symmetry plane of the patient.\n\nTechnically, the introduction of this additional random variable doubles the space of the hidden states and therefore quadruples the size of the transition matrix $\\mathbf{A}$. However, since we assume no correlation between the tumor's lateralization and the metastases in the LNLs, we can evolve the two parts separately.\n\nThe probabilities to find a patient with a clearly lateralized tumor or one that extends over the mid-sagittal line after $t$ time-steps are then given by\n\n$$\n\\begin{aligned}\nP(\\epsilon = \\texttt{False} \\mid t) &= (1 - p_\\epsilon)^t \\\\\nP(\\epsilon = \\texttt{True} \\mid t) &= 1 - P(\\epsilon = \\texttt{False} \\mid t)\n\\end{aligned}\n$$\n\nTo get the joint probability over the ipsi- and contralateral hidden states, as well as the state of the tumor's midline extension $P \\left( \\mathbf{X}^\\text{i}, \\mathbf{X}^\\text{c}, \\epsilon \\right)$, we simply add the above terms to the marginalization in @eq-bilateral-marginal:\n\n$$\nP \\left( \\mathbf{X}^\\text{i}, \\mathbf{X}^\\text{c}, \\epsilon \\right) = \\sum_{t=0}^{t_\\text{max}} P(t) \\cdot P(\\epsilon \\mid t) \\cdot P \\left( \\mathbf{X}^\\text{i} \\mid t \\right) \\cdot P \\left( \\mathbf{X}^\\text{c} \\mid t \\right)\n$$\n\nAgain, this can be written algebraically, by defining the vector $P(\\mathbf{t}, \\epsilon) = P(\\mathbf{t}) \\cdot P(\\epsilon \\mid \\mathbf{t})$, to achieve the same form as in @eq-bilateral-marginal-algebra:\n\n$$\nP \\left( \\mathbf{X}^\\text{i} = \\boldsymbol{\\xi}_n, \\mathbf{X}^\\text{c} = \\boldsymbol{\\xi}_m, \\epsilon \\right) = \\left[ \\boldsymbol{\\Lambda}^\\intercal_\\text{i} \\cdot \\operatorname{diag} P(\\mathbf{t}, \\epsilon) \\cdot \\boldsymbol{\\Lambda}_\\text{c} \\right]_{n,m}\n$$\n\nIn @fig-midext-evo, we visualize how the prior distribution over diagnose times $P(t)$, the conditional probability of midline extension $P(\\epsilon \\mid t)$, and their joint $P(\\epsilon, t)$ evolve over the course of a patient evolution.\n:::\n\n::: {#cell-fig-midext-evo .cell execution_count=5}\n``` {.python .cell-code .hidden}\nt = np.linspace(0, 10, 11)\np_midline = {\n  \"lateralized\": (1 - midline_model.midext_prob)**t,\n  \"extension\": 1 - (1 - midline_model.midext_prob)**t,\n}\ndist = {\n  \"early\": midline_model.get_distribution(\"early\").pmf,\n  \"late\": midline_model.get_distribution(\"late\").pmf,\n}\np_colors = {\"lateralized\": COLORS[\"green\"], \"extension\": COLORS[\"red\"]}\nt_colors = {\"early\": COLORS[\"blue\"], \"late\": COLORS[\"orange\"]}\nmarkers = {}\n\nnrows, ncols = 2, 1\nplt.rcParams.update(shared.get_fontsizes())\nplt.rcParams.update(shared.get_figsizes(\n  nrows=nrows,\n  ncols=ncols,\n  width=half,\n  aspect_ratio=2.5,\n))\n\nfig, axes = plt.subplots(nrows=nrows, ncols=ncols, sharex=True)\nw = 0.3\n\nfor label, p in p_midline.items():\n  axes[0].plot(\n    t, p_midline[label], \"o-\",\n    label=f\"cond. prob. $P(\\epsilon={label=='extension'} \\mid t)$\",\n    color=p_colors[label],\n  )\n  for i, t_stage in enumerate([\"early\", \"late\"]):\n    if label == \"lateralized\":\n      axes[0].bar(\n        t + i*w - w/2, dist[t_stage],\n        color=t_colors[t_stage],\n        width=w,\n        label=f\"{t_stage} T-cat. prior $P(t)$\",\n      )\n    axes[1].plot(\n      t, p * dist[t_stage], \"o-\",\n      c=p_colors[label],\n      mfc=t_colors[t_stage],\n      mec=t_colors[t_stage],\n      label=f\"{label} ($\\epsilon={label=='extension'}$) for {t_stage} T-cat.\",\n    )\n\naxes[0].set_ylim(0., 1.)\naxes[0].yaxis.set_major_formatter(ticker.StrMethodFormatter(\"{x:.0%}\"))\naxes[0].set_ylabel(\"probability\")\naxes[0].grid(axis=\"y\", color=COLORS[\"gray\"], alpha=0.5)\n\naxes[0].legend()\n\naxes[1].set_xlim(min(t), max(t))\naxes[1].set_xticks(t)\naxes[1].set_xlabel(\"time-step $t$\")\n\naxes[1].set_ylim(0., 0.25)\naxes[1].yaxis.set_major_formatter(ticker.StrMethodFormatter(\"{x:.0%}\"))\naxes[1].set_ylabel(\"joint probability $P(\\epsilon, t)$\")\naxes[1].grid(axis=\"y\", color=COLORS[\"gray\"], alpha=0.5)\n\naxes[1].legend()\n\nplt.show()\n```\n\n::: {.cell-output .cell-output-display}\n![The top panel shows the prior probability to get diagnosed at time-step $t$ for early and late T-category tumors as bars. Also in the top panel, we plot the conditional probability of the tumor's midline extension ($\\epsilon=\\texttt{True}$), given the time-step $t$ as a line plot. In the bottom panel, we show the joint probability of getting diagnosed in time-step $t$ *and* having a tumor that crosses the midline.](manuscript_files/figure-html/fig-midext-evo-output-1.png){#fig-midext-evo width=620 height=491}\n:::\n:::\n\n\n:::{#81fb41eb .cell .markdown}\n## Parameter Symmetries {#sec-params-symmetry}\n\nIn general, the matrices $\\boldsymbol{\\Lambda}_\\text{i}$ and $\\boldsymbol{\\Lambda}_\\text{c}$ could be parameterized using a disjoint set of parameters. I.e., the ipsi- and contralateral spread rates are entirely different. However, using two sensible assumptions, we can reduce the parameter space by sharing some parameters between the sides:\n\n1. We assume the spread *among* the LNLs to be same on both sides. It is reasonable to assume the lymphatic system is symmetric. Thus, the spread rates from one LNL to the other should be symmetric, too. Formally, this means \\\n   $$\n   \\begin{aligned}\n   b_v^\\text{c} &\\neq b_v^\\text{i} \\\\\n   t_{rv}^\\text{c} &= t_{rv}^\\text{i}\n   \\end{aligned}\n   $$ {#eq-symmetries}\n   for all $v \\leq V$ and $r \\in \\operatorname{pa}(v)$.\n2. The tumor's spread to the contralateral side in case of an extension over the midline is larger than if it was clearly lateralized, but smaller than its spread to the ipsilateral side. This assumption stems from a simple thought experiment: Consider moving the tumor from a clearly lateralized position accross the mid-sagittal plane to the same position, but on the contralateral side. In the beginning we would have $b_v^\\text{c} < b_v^\\text{i}$, while in the end, the situation is reversed. If a tumor extends over the mid-sagittal line, its contralateral spread rate can be expected to be in between these two extremes. We encode this in a *mixing parameter* $\\alpha$ that captures a \"degree of asymmetry\": \\\n   $$\n   b_v^{\\text{c},\\epsilon=\\texttt{True}} = \\alpha \\cdot b_v^\\text{i} + (1 - \\alpha) \\cdot b_v^{\\text{c},\\epsilon=\\texttt{False}}\n   $$ {#eq-mixing}\n   This means the model now uses three different sets of parameters to describe the spread from the tumor to the LNLs: $b^\\text{i}_v$ for the spread to the ipsilateral LNLs, $b_v^{\\text{c},\\epsilon=\\texttt{False}}$ for the spread to the contralateral LNLs as long as the tumor is clearly lateralized, and finally $b_v^{\\text{c},\\epsilon=\\texttt{True}}$ when it crosses the midline. Note, however, that these three sets of spread rates only account for $2 \\cdot 2^V + 1$ parameters, since they are coupled via the mixing parameter $\\alpha$.\n\nTogether with the explicit modelling of the tumor's midline extension $\\epsilon$ from @sec-midline, we now have a model that may be capable of capturing the higher prevalence of contralateral involvment that comes with tumors extending over the mid-sagittal line.\n\n\n# Methods\n\nWe compared three different aprroaches to modelling the contralateral involvement in OPSCC:\n\n1. A naive model of the contralateral side only. Neither the patterns of ipsilateral involvement, nor the information on whether the patients' tumors crossed the mid-sagittal line enter this model.\n2. The bilateral model as introduced in the sections up to and including @sec-params-symmetry. The involvement patterns of both sides enter this model, but not whether the tumors extended the midline.\n3. An additional bilateral model that tracks the midline extension of the patients' tumors as a random variable. This includes the formalism introduced up to and including @sec-midline. In contrast to the other two models, it does consider the reported midline extension in the data to attempt a more accurate prediction of the risk for contralateral occult disease.\n\n## MCMC Sampling {#sec-sampling}\n\n- all models initialized with the same settings\n  - same graph\n  - same data\n  - same distributions over diagnose time\n- parameter samples were drawn for all three models:\n  - the sampling used {{< var sampling.walkers_per_dim >}} walkers per parameter space dimension.\n  - Every {{< var sampling.check_interval >}} steps, convergence was checked\n  - convergence was reached when two criteria were met:\n      1. the relative difference between subsequent autocorrelation estimates of the chain does not change more than {{< var sampling.rel_thresh |  >}}.\n      2. the autocorrelation estimate of the chain drops below the length of the chain divided by {{< var sampling.trust_fac >}}.\n  - after convergence, {{< var sampling.nsteps >}} samples (from the parallel walkers) were drawn that were spaced {{< var sampling.thin >}} steps apart, resulting in `num params x {{< var sampling.walkers_per_dim >}} x {{< var sampling.nsteps >}}` parameter samples.\n\nFor every model, we compare the predicted prevalence of a certain scenario to how often this scenario is seen in the data. The considered scenarios are choosen to test if the models can take into account T-category, the correlation of ipsi- and contralateral involvement, and the primary tumor's lateralization (whether or not it extends over the mid-sagittal line).\n\n- [ ] list and describe the scenarios\n\n\n# Results\n:::\n\n::: {#cell-fig-burnin-history .cell execution_count=6}\n``` {.python .cell-code .hidden}\nfrom collections import namedtuple\n\ndef custom(x, pos):\n  return \"{:.1f}\".format(x/1000)\n\nnrows, ncols = 1, 3\nlabel_map = {\n  \"acor_times\": \"autocorrelation [steps]\",\n  \"accept_fracs\": \"acceptance fraction [%]\",\n  \"max_log_probs\": r\"max. log-likelihood [$\\times 10^3$]\",\n}\n\nplt.rcParams.update(shared.get_fontsizes())\nplt.rcParams.update(shared.get_figsizes(\n  nrows=nrows,\n  ncols=ncols,\n  aspect_ratio=1.,\n  width=full,\n))\n\nfig, axes = plt.subplots(\n  nrows=nrows,\n  ncols=ncols,\n  sharex=True,\n)\n\nfor model in [\"contra\", \"bilateral\", \"midline\"]:\n  history = pd.read_csv(f\"models/{model}/history.csv\").set_index(\"steps\")\n  for i, column in enumerate(history.columns):\n    history.plot(y=column, ax=axes[i], label=model)\n    axes[i].autoscale(enable=True, tight=True, axis=\"x\")\n    axes[i].set_ylabel(label_map[column])\n    axes[i].xaxis.set_major_formatter(ticker.FuncFormatter(custom))\n    axes[i].set_xlabel(r\"steps [$\\times 10^3$]\")\n\naxes[1].yaxis.set_major_formatter(ticker.StrMethodFormatter(\"{x:.0%}\"))\naxes[2].yaxis.set_major_formatter(ticker.FuncFormatter(custom))\nplt.show()\n```\n\n::: {.cell-output .cell-output-display}\n![Monitoring quantities during the burn-in phase of the parameter sampling.](manuscript_files/figure-html/fig-burnin-history-output-1.png){#fig-burnin-history width=620 height=192}\n:::\n:::\n\n\n:::{#d0d130a0 .cell .markdown}\n@Fig-burnin-history is only a temporary placeholder for now.\n\n## Prevalence Comparisons\n\nFirst, we look at the prevalence of contralateral involvement for the LNLs II, III, and IV. The three models' predictions are plotted against beta posteriors of the observed prevalence in the data in @fig-prevalences-overall, both for early and advanced T-category.\n\nThe beta posteriors (drawn as lines in @fig-prevalences-overall) are a convenient way of indicating not only the percentage of patients that presented with any given involvement, T-category, and/or other characteristics, which sits at the maximum of the beta distribution. It also shows the size of the population via its variance: If we observe e.g. 3 out of 10 patients to have contralateral LNL II involvement when the primary tumor is of advanced T-stage, then we cannot be particularly sure about that rate to be truly 30%. However, when we observe 300 out of 1000, we can be much more certain. A beta posterior intuitively reflects that in its width and is thus better suited to display such data than e.g. a vertical line only.\n\nThe shaded histograms in @fig-prevalences-overall show the corresponding prevalence as computed by one of our models. They are formed by computing the prevalence for a number of parameter samples drawn during the MCMC learning process, as detailed in @sec-sampling. If both the location and width of the histograms matches those of the beta posteriors, then our model is both accurate and precise enough to describe the data.\n:::\n\n::: {#cell-fig-prevalences-overall .cell execution_count=7}\n``` {.python .cell-code .hidden}\nfrom itertools import cycle\nfrom lyscripts.scenario import Scenario\nfrom lyscripts.plot.utils import draw, BetaPosterior, Histogram, COLORS\n\nscenarios_config = utils.load_yaml_params(\"scenarios/overall.yaml\")\nscenarios = Scenario.list_from_params(scenarios_config)\n\nnrows, ncols = 2, 3\n\nplt.rcParams.update(shared.get_fontsizes())\nplt.rcParams.update(shared.get_figsizes(\n  nrows=nrows,\n  ncols=ncols,\n  width=full,\n))\n\nfig, axes = plt.subplots(nrows=nrows, ncols=ncols, sharex=\"col\")\n\naxes[0,0].set_ylabel(\"early\")\naxes[-1,0].set_ylabel(\"advanced\")\n\nfor col, model in enumerate([\"contra\", \"bilateral\", \"midline\"]):\n  axes[0,col].set_title(model)\n  axes[-1,col].set_xlabel(\"prevalence [%]\")\n  for row, t_stage in enumerate([\"early\", \"late\"]):\n    content = []\n    color_cycle = cycle(COLORS.values())\n    lnls = iter([\"II\", \"III\", \"IV\"])\n    for scenario in scenarios:\n      if not t_stage in scenario.t_stages:\n        continue\n\n      if model == \"contra\":\n        scenario = scenario.from_dict(\n          scenario.as_dict(\"prevalences\"),\n          is_uni=True,\n          side=\"contra\",\n        )\n\n      color = next(color_cycle)\n      content += [\n        Histogram.from_hdf5(\n          filename=paths.get_filename(\n            model=model,\n            kind=\"prevalences_overall\",\n          ),\n          dataname=scenario.md5_hash(\"prevalences\"),\n          color=color,\n          label=f\"contra LNL {next(lnls)}\"\n        ),\n        BetaPosterior.from_hdf5(\n          filename=paths.get_filename(\n            model=model,\n            kind=\"prevalences_overall\",\n          ),\n          dataname=scenario.md5_hash(\"prevalences\"),\n          color=color,\n        ),\n      ]\n    draw(\n      axes=axes[row,col],\n      contents=content,\n      percent_lims=(2., 2.),\n      xlims=(0., 27.)\n    )\n    axes[row,col].set_yticks([])\n\naxes[0,0].legend(labelspacing=0.2)\naxes[-1,-1].legend(labelspacing=0.2)\n```\n\n::: {.cell-output .cell-output-display}\n![Prevalences of contralateral LNL involvement for different scenarios and the three considered models. The colored histograms show the computed distribution over the prevalence of involvment in the contralateral levels II (blue), III (orange), and IV (red). Each model's prediction is shown in a separate column, while the rows show these prevalences computed for early (top row) and advanced T-category (bottom row) respectively. The lines depict beta-posteriors over the observed prevalence of the corresponding scenario using a uniform prior. Its maximum coincides with the percentage of patients with the involvement of interest and its width indicates how many patients were considered in total.](manuscript_files/figure-html/fig-prevalences-overall-output-1.png){#fig-prevalences-overall width=620 height=242}\n:::\n:::\n\n\n:::{#8b58b763 .cell .markdown}\nAt first, from @fig-prevalences-overall it appears as if the simpler, naive, unilateral-only model describes the prevalence of contralateral involvement better than the bilateral model and even the more complex model that tracks midline extension of the primary tumor.\n\n- [ ] make the data in the paragraph below dynamic\n\nThis is mainly due to the early/advanced T-category split of the ipsi- and contralateral side: All models use two different distributions for early and advanced T-category to marginalize over the diagnose times (as introduced in the recap of @sec-unilateral). But only the two bilateral models need to balance these distributions to describe the ipsi- and contralateral involvement simultaneaously. As can be seen in the second and third column of @fig-prevalences-overall, the prevalence of e.g. contralateral LNL II involvement in the data (blue lines) increases from 8% (39 out of 473) to 24% (88 out of 360). Which is more than the model predicts (blue histograms). Ipsilaterally, however, the involvement of LNL II increases from 71% (343 out of 473) to only 76% (276 out of 360). This much weaker increase is well capured by the models.\n\nThis issue is quickly resolved, though, as we consider other risk factors that correlate with T-category: Both the ipsilateral involvement and the tumor's extension over the mid-sagittal line influence -- the latter probably even causally -- the extent of contralateral involvement, as shown in @tbl-data-strat. Both these risk factors cannot be considered by the contralateral-only model. We should thus expect this naive model to perform worse, as soon as we investigate ipsilateral involvement and midline extension.\n:::\n\n::: {#cell-fig-prevalences-ipsi .cell execution_count=8}\n``` {.python .cell-code .hidden}\nscenarios_config = utils.load_yaml_params(\"scenarios/with_ipsi.yaml\")\nscenarios = Scenario.list_from_params(scenarios_config)\n\nnrows, ncols = 2, 3\n\nplt.rcParams.update(shared.get_fontsizes())\nplt.rcParams.update(shared.get_figsizes(\n  nrows=nrows,\n  ncols=ncols,\n  width=full,\n))\n\nfig, axes = plt.subplots(nrows=nrows, ncols=ncols, sharex=\"col\")\n\naxes[0,0].set_ylabel(\"early\")\naxes[-1,0].set_ylabel(\"advanced\")\n\nfor col, model in enumerate([\"contra\", \"bilateral\", \"midline\"]):\n  axes[0,col].set_title(model)\n  axes[-1,col].set_xlabel(\"prevalence [%]\")\n  for row, t_stage in enumerate([\"early\", \"late\"]):\n    content = []\n    color_cycle = cycle(COLORS.values())\n    lnls = iter([\"II\", \"III\", \"IV\"])\n    for scenario in scenarios:\n      if not t_stage in scenario.t_stages:\n        continue\n\n      if model == \"contra\":\n        scenario = scenario.from_dict(\n          scenario.as_dict(\"prevalences\"),\n          is_uni=True,\n          side=\"contra\",\n        )\n\n      color = next(color_cycle)\n      content += [\n        Histogram.from_hdf5(\n          filename=paths.get_filename(\n            model=model,\n            kind=\"prevalences_with_ipsi\",\n          ),\n          dataname=scenario.md5_hash(\"prevalences\"),\n          color=color,\n          label=f\"contra LNL {next(lnls)}\"\n        ),\n        BetaPosterior.from_hdf5(\n          filename=paths.get_filename(\n            model=model,\n            kind=\"prevalences_with_ipsi\",\n          ),\n          dataname=scenario.md5_hash(\"prevalences\"),\n          color=color,\n        ),\n      ]\n    draw(\n      axes=axes[row,col],\n      contents=content,\n      percent_lims=(2., 2.),\n      xlims=(0., 27.)\n    )\n    axes[row,col].set_yticks([])\n\naxes[0,0].legend(labelspacing=0.2)\naxes[-1,-1].legend(labelspacing=0.2)\n```\n\n::: {.cell-output .cell-output-display}\n![Contralateral prevalences when taking ipsilateral invovlement into account.](manuscript_files/figure-html/fig-prevalences-ipsi-output-1.png){#fig-prevalences-ipsi width=620 height=242}\n:::\n:::\n\n\n:::{#544758cd .cell .markdown}\n## Parameter Estimates\n:::\n\n::: {#tbl-midline-params .cell tbl-cap='Mean sampled parameter estimates of the midline model and the respective standard deviation.' execution_count=9}\n``` {.python .cell-code .hidden}\ndef map_param_names(name: str) -> str:\n  \"\"\"Make parameter names more readable.\"\"\"\n  try:\n    return {\n      \"midext_prob\": \"Mid. ext. probability\",\n      \"mixing\": \"Mixing ⍺\",\n      \"late_p\": \"late T-cat. binom. prob.\",\n    }[name]\n  except KeyError:\n    return re.sub(\n      r\"(ipsi|contra)_\", r\"\\g<1>: \", name\n    ).replace(\n      \"to\", \" ➜ \"\n    ).replace(\n      \"_spread\", \"\"\n    )\n\nmodel = shared.get_model(which=\"midline\", load_samples=True)\nsamples = shared.get_samples(which=\"midline\")\n\nnames = [map_param_names(p) for p in model.get_params()]\nmeans, stds = samples.mean(axis=0), samples.std(axis=0)\n\nearly_midext_prob = model.state_dist(t_stage=\"early\")[1].sum()\nlate_midext_prob = model.state_dist(t_stage=\"late\")[1].sum()\n\nparams_table = pd.DataFrame({\"Parameter\": names, \"Mean\": means, \"Std. Dev.\": stds})\n(\n  params_table.style\n  .format(\"{:.2%}\", subset=[\"Mean\"])\n  .format(\"± {:.2%}\", subset=[\"Std. Dev.\"])\n  .apply(right_align, subset=[\"Mean\", \"Std. Dev.\"])\n  .hide()\n)\n```\n\n::: {.cell-output .cell-output-display execution_count=18}\n```{=html}\n<style type=\"text/css\">\n#T_43202_row0_col1, #T_43202_row0_col2, #T_43202_row1_col1, #T_43202_row1_col2, #T_43202_row2_col1, #T_43202_row2_col2, #T_43202_row3_col1, #T_43202_row3_col2, #T_43202_row4_col1, #T_43202_row4_col2, #T_43202_row5_col1, #T_43202_row5_col2, #T_43202_row6_col1, #T_43202_row6_col2, #T_43202_row7_col1, #T_43202_row7_col2, #T_43202_row8_col1, #T_43202_row8_col2, #T_43202_row9_col1, #T_43202_row9_col2, #T_43202_row10_col1, #T_43202_row10_col2 {\n  text-align: right;\n}\n</style>\n<table id=\"T_43202\">\n  <thead>\n    <tr>\n      <th id=\"T_43202_level0_col0\" class=\"col_heading level0 col0\" >Parameter</th>\n      <th id=\"T_43202_level0_col1\" class=\"col_heading level0 col1\" >Mean</th>\n      <th id=\"T_43202_level0_col2\" class=\"col_heading level0 col2\" >Std. Dev.</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td id=\"T_43202_row0_col0\" class=\"data row0 col0\" >Mid. ext. probability</td>\n      <td id=\"T_43202_row0_col1\" class=\"data row0 col1\" >8.13%</td>\n      <td id=\"T_43202_row0_col2\" class=\"data row0 col2\" >± 0.60%</td>\n    </tr>\n    <tr>\n      <td id=\"T_43202_row1_col0\" class=\"data row1 col0\" >ipsi: T ➜ II</td>\n      <td id=\"T_43202_row1_col1\" class=\"data row1 col1\" >35.45%</td>\n      <td id=\"T_43202_row1_col2\" class=\"data row1 col2\" >± 1.75%</td>\n    </tr>\n    <tr>\n      <td id=\"T_43202_row2_col0\" class=\"data row2 col0\" >ipsi: T ➜ III</td>\n      <td id=\"T_43202_row2_col1\" class=\"data row2 col1\" >5.59%</td>\n      <td id=\"T_43202_row2_col2\" class=\"data row2 col2\" >± 0.82%</td>\n    </tr>\n    <tr>\n      <td id=\"T_43202_row3_col0\" class=\"data row3 col0\" >ipsi: T ➜ IV</td>\n      <td id=\"T_43202_row3_col1\" class=\"data row3 col1\" >0.91%</td>\n      <td id=\"T_43202_row3_col2\" class=\"data row3 col2\" >± 0.21%</td>\n    </tr>\n    <tr>\n      <td id=\"T_43202_row4_col0\" class=\"data row4 col0\" >contra: T ➜ II</td>\n      <td id=\"T_43202_row4_col1\" class=\"data row4 col1\" >2.64%</td>\n      <td id=\"T_43202_row4_col2\" class=\"data row4 col2\" >± 0.35%</td>\n    </tr>\n    <tr>\n      <td id=\"T_43202_row5_col0\" class=\"data row5 col0\" >contra: T ➜ III</td>\n      <td id=\"T_43202_row5_col1\" class=\"data row5 col1\" >0.16%</td>\n      <td id=\"T_43202_row5_col2\" class=\"data row5 col2\" >± 0.09%</td>\n    </tr>\n    <tr>\n      <td id=\"T_43202_row6_col0\" class=\"data row6 col0\" >contra: T ➜ IV</td>\n      <td id=\"T_43202_row6_col1\" class=\"data row6 col1\" >0.21%</td>\n      <td id=\"T_43202_row6_col2\" class=\"data row6 col2\" >± 0.10%</td>\n    </tr>\n    <tr>\n      <td id=\"T_43202_row7_col0\" class=\"data row7 col0\" >Mixing ⍺</td>\n      <td id=\"T_43202_row7_col1\" class=\"data row7 col1\" >21.01%</td>\n      <td id=\"T_43202_row7_col2\" class=\"data row7 col2\" >± 3.24%</td>\n    </tr>\n    <tr>\n      <td id=\"T_43202_row8_col0\" class=\"data row8 col0\" >II ➜ III</td>\n      <td id=\"T_43202_row8_col1\" class=\"data row8 col1\" >13.46%</td>\n      <td id=\"T_43202_row8_col2\" class=\"data row8 col2\" >± 1.95%</td>\n    </tr>\n    <tr>\n      <td id=\"T_43202_row9_col0\" class=\"data row9 col0\" >III ➜ IV</td>\n      <td id=\"T_43202_row9_col1\" class=\"data row9 col1\" >15.74%</td>\n      <td id=\"T_43202_row9_col2\" class=\"data row9 col2\" >± 2.24%</td>\n    </tr>\n    <tr>\n      <td id=\"T_43202_row10_col0\" class=\"data row10 col0\" >late T-cat. binom. prob.</td>\n      <td id=\"T_43202_row10_col1\" class=\"data row10 col1\" >45.35%</td>\n      <td id=\"T_43202_row10_col2\" class=\"data row10 col2\" >± 2.57%</td>\n    </tr>\n  </tbody>\n</table>\n```\n:::\n:::\n\n\n:::{#6cb73859 .cell .markdown}\nThe predicted prevalence of midline extension for early T-category tumors is <!-- insert computational code later -->. For a late T-category tumor, it is <!-- insert computational code later -->.\n\nIn the data, the prevalence of midline extension for early T-category tumors is <!-- insert computational code later -->. For late T-category tumors it is <!-- insert computational code later -->.\n\n- Discrepancy between data and model is due to late T-stage's time prior\n- still tied to other parameters\n- cannot fully represent spread of midline extension and also represent spread params\n\n\n## Distributions over States\n:::\n\n::: {#fecf45cd .cell execution_count=10}\n``` {.python .cell-code .hidden}\nplt.rcdefaults()\n\nmi = pd.MultiIndex.from_product(\n  [[False, True]] * len(midline_model.ext.ipsi.graph.lnls),\n  names=midline_model.ext.ipsi.graph.lnls.keys(),\n)\nseries = pd.Series(midline_model.ext.ipsi.state_dist(), index=mi)\nupsetplot.plot(\n  series,\n  sort_by=\"cardinality\",\n  sort_categories_by=\"-input\",\n)\nplt.show()\n```\n\n::: {.cell-output .cell-output-display}\n![](manuscript_files/figure-html/cell-10-output-1.png){}\n:::\n:::\n\n\n:::{#ceebc20f .cell .markdown}\n# Acknowledgement {.appendix}\n\nThis work was supported by:\n\n- the Clinical Research Priority Program \"Artificial Intelligence in Oncological Imaging\" of the University of Zurich\n- the Swiss Cancer Research Foundation under grant number KFS 5645-08-2022\n\n\n# Appendix {.appendix}\n:::\n\n::: {#tbl-data-strat .cell tbl-cap='Contralateral involvement depending on whether the primary tumor extends over the mid-sagittal line, the T-category, and whether the ipsilateral LNL III was involved or healthy.' execution_count=11}\n``` {.python .cell-code .hidden}\ndata = raw.copy()\ndata[COL.t_stage] = data[COL.t_stage].apply(lambda x: \"early\" if x <= 2 else \"late\")\nearly_midext_data = (data.loc[data[COL.t_stage] == \"early\", COL.midext] == True).mean()\nlate_midext_data = (data.loc[data[COL.t_stage] == \"late\", COL.midext] == True).mean()\ngrouped = data.groupby(by=[COL.midext, COL.t_stage, COL.ipsi_III])\n\nlnl_cols = get_lnl_cols(\"contra\", lnls=[\"I\", \"II\", \"III\", \"IV\"])\ntotal = grouped.count()[lnl_cols][\"max_llh\", \"contra\"]\nidx = total.index.rename([\"Mid. ext.\", \"T-cat.\", \"ipsi III\"])\n\nnum_involved = grouped.sum()[lnl_cols][\"max_llh\", \"contra\"]\npercent_involved = num_involved / total\ntotal.index = idx\nnum_involved.index = idx\npercent_involved.index = idx\n\ninvolved = num_involved.join(\n  100 * percent_involved,\n  rsuffix=\" (%)\",\n).sort_index(axis=\"columns\")\ninvolved.columns = pd.MultiIndex.from_product(\n  [[\"I\", \"II\", \"III\", \"IV\"],\n   [\"n\", \"%\"]],\n  names=[\"LNL\", \"\"]\n)\n(\n  involved\n  .reset_index()\n  .style\n  .format(precision=2)\n  .apply(right_align, subset=involved.columns[0:])\n  .apply(highlight_bool, subset=[\"Mid. ext.\", \"ipsi III\"])\n  .apply(highlight_t_stage, subset=[\"T-cat.\"])\n  .hide()\n)\n```\n\n::: {.cell-output .cell-output-display execution_count=20}\n```{=html}\n<style type=\"text/css\">\n#T_8fda6_row0_col0, #T_8fda6_row0_col1, #T_8fda6_row0_col2, #T_8fda6_row1_col0, #T_8fda6_row1_col1, #T_8fda6_row2_col0, #T_8fda6_row2_col2, #T_8fda6_row3_col0, #T_8fda6_row4_col1, #T_8fda6_row4_col2, #T_8fda6_row5_col1, #T_8fda6_row6_col2 {\n  color: #00afa5;\n}\n#T_8fda6_row0_col3, #T_8fda6_row0_col4, #T_8fda6_row0_col5, #T_8fda6_row0_col6, #T_8fda6_row0_col7, #T_8fda6_row0_col8, #T_8fda6_row0_col9, #T_8fda6_row0_col10, #T_8fda6_row1_col3, #T_8fda6_row1_col4, #T_8fda6_row1_col5, #T_8fda6_row1_col6, #T_8fda6_row1_col7, #T_8fda6_row1_col8, #T_8fda6_row1_col9, #T_8fda6_row1_col10, #T_8fda6_row2_col3, #T_8fda6_row2_col4, #T_8fda6_row2_col5, #T_8fda6_row2_col6, #T_8fda6_row2_col7, #T_8fda6_row2_col8, #T_8fda6_row2_col9, #T_8fda6_row2_col10, #T_8fda6_row3_col3, #T_8fda6_row3_col4, #T_8fda6_row3_col5, #T_8fda6_row3_col6, #T_8fda6_row3_col7, #T_8fda6_row3_col8, #T_8fda6_row3_col9, #T_8fda6_row3_col10, #T_8fda6_row4_col3, #T_8fda6_row4_col4, #T_8fda6_row4_col5, #T_8fda6_row4_col6, #T_8fda6_row4_col7, #T_8fda6_row4_col8, #T_8fda6_row4_col9, #T_8fda6_row4_col10, #T_8fda6_row5_col3, #T_8fda6_row5_col4, #T_8fda6_row5_col5, #T_8fda6_row5_col6, #T_8fda6_row5_col7, #T_8fda6_row5_col8, #T_8fda6_row5_col9, #T_8fda6_row5_col10, #T_8fda6_row6_col3, #T_8fda6_row6_col4, #T_8fda6_row6_col5, #T_8fda6_row6_col6, #T_8fda6_row6_col7, #T_8fda6_row6_col8, #T_8fda6_row6_col9, #T_8fda6_row6_col10, #T_8fda6_row7_col3, #T_8fda6_row7_col4, #T_8fda6_row7_col5, #T_8fda6_row7_col6, #T_8fda6_row7_col7, #T_8fda6_row7_col8, #T_8fda6_row7_col9, #T_8fda6_row7_col10 {\n  text-align: right;\n}\n#T_8fda6_row1_col2, #T_8fda6_row2_col1, #T_8fda6_row3_col1, #T_8fda6_row3_col2, #T_8fda6_row4_col0, #T_8fda6_row5_col0, #T_8fda6_row5_col2, #T_8fda6_row6_col0, #T_8fda6_row6_col1, #T_8fda6_row7_col0, #T_8fda6_row7_col1, #T_8fda6_row7_col2 {\n  color: #ae0060;\n}\n</style>\n<table id=\"T_8fda6\">\n  <thead>\n    <tr>\n      <th id=\"T_8fda6_level0_col0\" class=\"col_heading level0 col0\" >Mid. ext.</th>\n      <th id=\"T_8fda6_level0_col1\" class=\"col_heading level0 col1\" >T-cat.</th>\n      <th id=\"T_8fda6_level0_col2\" class=\"col_heading level0 col2\" >ipsi III</th>\n      <th id=\"T_8fda6_level0_col3\" class=\"col_heading level0 col3\" colspan=\"2\">I</th>\n      <th id=\"T_8fda6_level0_col5\" class=\"col_heading level0 col5\" colspan=\"2\">II</th>\n      <th id=\"T_8fda6_level0_col7\" class=\"col_heading level0 col7\" colspan=\"2\">III</th>\n      <th id=\"T_8fda6_level0_col9\" class=\"col_heading level0 col9\" colspan=\"2\">IV</th>\n    </tr>\n    <tr>\n      <th id=\"T_8fda6_level1_col0\" class=\"col_heading level1 col0\" ></th>\n      <th id=\"T_8fda6_level1_col1\" class=\"col_heading level1 col1\" ></th>\n      <th id=\"T_8fda6_level1_col2\" class=\"col_heading level1 col2\" ></th>\n      <th id=\"T_8fda6_level1_col3\" class=\"col_heading level1 col3\" >n</th>\n      <th id=\"T_8fda6_level1_col4\" class=\"col_heading level1 col4\" >%</th>\n      <th id=\"T_8fda6_level1_col5\" class=\"col_heading level1 col5\" >n</th>\n      <th id=\"T_8fda6_level1_col6\" class=\"col_heading level1 col6\" >%</th>\n      <th id=\"T_8fda6_level1_col7\" class=\"col_heading level1 col7\" >n</th>\n      <th id=\"T_8fda6_level1_col8\" class=\"col_heading level1 col8\" >%</th>\n      <th id=\"T_8fda6_level1_col9\" class=\"col_heading level1 col9\" >n</th>\n      <th id=\"T_8fda6_level1_col10\" class=\"col_heading level1 col10\" >%</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td id=\"T_8fda6_row0_col0\" class=\"data row0 col0\" >False</td>\n      <td id=\"T_8fda6_row0_col1\" class=\"data row0 col1\" >early</td>\n      <td id=\"T_8fda6_row0_col2\" class=\"data row0 col2\" >False</td>\n      <td id=\"T_8fda6_row0_col3\" class=\"data row0 col3\" >1</td>\n      <td id=\"T_8fda6_row0_col4\" class=\"data row0 col4\" >0.36</td>\n      <td id=\"T_8fda6_row0_col5\" class=\"data row0 col5\" >13</td>\n      <td id=\"T_8fda6_row0_col6\" class=\"data row0 col6\" >4.74</td>\n      <td id=\"T_8fda6_row0_col7\" class=\"data row0 col7\" >2</td>\n      <td id=\"T_8fda6_row0_col8\" class=\"data row0 col8\" >0.73</td>\n      <td id=\"T_8fda6_row0_col9\" class=\"data row0 col9\" >1</td>\n      <td id=\"T_8fda6_row0_col10\" class=\"data row0 col10\" >0.37</td>\n    </tr>\n    <tr>\n      <td id=\"T_8fda6_row1_col0\" class=\"data row1 col0\" >False</td>\n      <td id=\"T_8fda6_row1_col1\" class=\"data row1 col1\" >early</td>\n      <td id=\"T_8fda6_row1_col2\" class=\"data row1 col2\" >True</td>\n      <td id=\"T_8fda6_row1_col3\" class=\"data row1 col3\" >1</td>\n      <td id=\"T_8fda6_row1_col4\" class=\"data row1 col4\" >0.95</td>\n      <td id=\"T_8fda6_row1_col5\" class=\"data row1 col5\" >14</td>\n      <td id=\"T_8fda6_row1_col6\" class=\"data row1 col6\" >13.33</td>\n      <td id=\"T_8fda6_row1_col7\" class=\"data row1 col7\" >3</td>\n      <td id=\"T_8fda6_row1_col8\" class=\"data row1 col8\" >2.86</td>\n      <td id=\"T_8fda6_row1_col9\" class=\"data row1 col9\" >3</td>\n      <td id=\"T_8fda6_row1_col10\" class=\"data row1 col10\" >2.86</td>\n    </tr>\n    <tr>\n      <td id=\"T_8fda6_row2_col0\" class=\"data row2 col0\" >False</td>\n      <td id=\"T_8fda6_row2_col1\" class=\"data row2 col1\" >late</td>\n      <td id=\"T_8fda6_row2_col2\" class=\"data row2 col2\" >False</td>\n      <td id=\"T_8fda6_row2_col3\" class=\"data row2 col3\" >2</td>\n      <td id=\"T_8fda6_row2_col4\" class=\"data row2 col4\" >1.68</td>\n      <td id=\"T_8fda6_row2_col5\" class=\"data row2 col5\" >8</td>\n      <td id=\"T_8fda6_row2_col6\" class=\"data row2 col6\" >6.72</td>\n      <td id=\"T_8fda6_row2_col7\" class=\"data row2 col7\" >1</td>\n      <td id=\"T_8fda6_row2_col8\" class=\"data row2 col8\" >0.84</td>\n      <td id=\"T_8fda6_row2_col9\" class=\"data row2 col9\" >1</td>\n      <td id=\"T_8fda6_row2_col10\" class=\"data row2 col10\" >0.84</td>\n    </tr>\n    <tr>\n      <td id=\"T_8fda6_row3_col0\" class=\"data row3 col0\" >False</td>\n      <td id=\"T_8fda6_row3_col1\" class=\"data row3 col1\" >late</td>\n      <td id=\"T_8fda6_row3_col2\" class=\"data row3 col2\" >True</td>\n      <td id=\"T_8fda6_row3_col3\" class=\"data row3 col3\" >2</td>\n      <td id=\"T_8fda6_row3_col4\" class=\"data row3 col4\" >3.51</td>\n      <td id=\"T_8fda6_row3_col5\" class=\"data row3 col5\" >13</td>\n      <td id=\"T_8fda6_row3_col6\" class=\"data row3 col6\" >22.81</td>\n      <td id=\"T_8fda6_row3_col7\" class=\"data row3 col7\" >6</td>\n      <td id=\"T_8fda6_row3_col8\" class=\"data row3 col8\" >10.53</td>\n      <td id=\"T_8fda6_row3_col9\" class=\"data row3 col9\" >3</td>\n      <td id=\"T_8fda6_row3_col10\" class=\"data row3 col10\" >5.26</td>\n    </tr>\n    <tr>\n      <td id=\"T_8fda6_row4_col0\" class=\"data row4 col0\" >True</td>\n      <td id=\"T_8fda6_row4_col1\" class=\"data row4 col1\" >early</td>\n      <td id=\"T_8fda6_row4_col2\" class=\"data row4 col2\" >False</td>\n      <td id=\"T_8fda6_row4_col3\" class=\"data row4 col3\" >1</td>\n      <td id=\"T_8fda6_row4_col4\" class=\"data row4 col4\" >5.56</td>\n      <td id=\"T_8fda6_row4_col5\" class=\"data row4 col5\" >3</td>\n      <td id=\"T_8fda6_row4_col6\" class=\"data row4 col6\" >16.67</td>\n      <td id=\"T_8fda6_row4_col7\" class=\"data row4 col7\" >1</td>\n      <td id=\"T_8fda6_row4_col8\" class=\"data row4 col8\" >5.56</td>\n      <td id=\"T_8fda6_row4_col9\" class=\"data row4 col9\" >0</td>\n      <td id=\"T_8fda6_row4_col10\" class=\"data row4 col10\" >0.00</td>\n    </tr>\n    <tr>\n      <td id=\"T_8fda6_row5_col0\" class=\"data row5 col0\" >True</td>\n      <td id=\"T_8fda6_row5_col1\" class=\"data row5 col1\" >early</td>\n      <td id=\"T_8fda6_row5_col2\" class=\"data row5 col2\" >True</td>\n      <td id=\"T_8fda6_row5_col3\" class=\"data row5 col3\" >0</td>\n      <td id=\"T_8fda6_row5_col4\" class=\"data row5 col4\" >0.00</td>\n      <td id=\"T_8fda6_row5_col5\" class=\"data row5 col5\" >3</td>\n      <td id=\"T_8fda6_row5_col6\" class=\"data row5 col6\" >27.27</td>\n      <td id=\"T_8fda6_row5_col7\" class=\"data row5 col7\" >4</td>\n      <td id=\"T_8fda6_row5_col8\" class=\"data row5 col8\" >36.36</td>\n      <td id=\"T_8fda6_row5_col9\" class=\"data row5 col9\" >1</td>\n      <td id=\"T_8fda6_row5_col10\" class=\"data row5 col10\" >9.09</td>\n    </tr>\n    <tr>\n      <td id=\"T_8fda6_row6_col0\" class=\"data row6 col0\" >True</td>\n      <td id=\"T_8fda6_row6_col1\" class=\"data row6 col1\" >late</td>\n      <td id=\"T_8fda6_row6_col2\" class=\"data row6 col2\" >False</td>\n      <td id=\"T_8fda6_row6_col3\" class=\"data row6 col3\" >2</td>\n      <td id=\"T_8fda6_row6_col4\" class=\"data row6 col4\" >2.27</td>\n      <td id=\"T_8fda6_row6_col5\" class=\"data row6 col5\" >26</td>\n      <td id=\"T_8fda6_row6_col6\" class=\"data row6 col6\" >29.55</td>\n      <td id=\"T_8fda6_row6_col7\" class=\"data row6 col7\" >6</td>\n      <td id=\"T_8fda6_row6_col8\" class=\"data row6 col8\" >6.82</td>\n      <td id=\"T_8fda6_row6_col9\" class=\"data row6 col9\" >2</td>\n      <td id=\"T_8fda6_row6_col10\" class=\"data row6 col10\" >2.27</td>\n    </tr>\n    <tr>\n      <td id=\"T_8fda6_row7_col0\" class=\"data row7 col0\" >True</td>\n      <td id=\"T_8fda6_row7_col1\" class=\"data row7 col1\" >late</td>\n      <td id=\"T_8fda6_row7_col2\" class=\"data row7 col2\" >True</td>\n      <td id=\"T_8fda6_row7_col3\" class=\"data row7 col3\" >2</td>\n      <td id=\"T_8fda6_row7_col4\" class=\"data row7 col4\" >2.63</td>\n      <td id=\"T_8fda6_row7_col5\" class=\"data row7 col5\" >41</td>\n      <td id=\"T_8fda6_row7_col6\" class=\"data row7 col6\" >53.95</td>\n      <td id=\"T_8fda6_row7_col7\" class=\"data row7 col7\" >17</td>\n      <td id=\"T_8fda6_row7_col8\" class=\"data row7 col8\" >22.37</td>\n      <td id=\"T_8fda6_row7_col9\" class=\"data row7 col9\" >7</td>\n      <td id=\"T_8fda6_row7_col10\" class=\"data row7 col10\" >9.21</td>\n    </tr>\n  </tbody>\n</table>\n```\n:::\n:::\n\n\n",
    "supporting": [
      "manuscript_files/figure-html"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js\" integrity=\"sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js\" integrity=\"sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==\" crossorigin=\"anonymous\" data-relocate-top=\"true\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n"
      ]
    }
  }
}